version: "3.9"

networks:
  cuchemNet:
    name: cuchemNet${RUN_ID}
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET}

services:
  cuchemUI:
    container_name: cuchemUI${RUN_ID}
    image: "${CUCHEM_CONT}"
    hostname: cuchemUI
    networks:
      cuchemNet:
        ipv4_address: ${IP_CUCHEM_UI}
    ports:
      - "${PLOTLY_PORT}:5000"
    volumes:
      - './:/workspace'
      - "${CONTENT_PATH}/data:/data"
    user: "${UID}:${GID}"
    working_dir: ${CUCHEM_PATH}
    command: ${CUCHEM_UI_START_CMD}
    extra_hosts:
      - "megamolbart:${IP_MEGAMOLBART}"
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            capabilities: [gpu]

  megamolbart:
    container_name: megamolbart${RUN_ID}
    image: "${MEGAMOLBART_CONT}"
    hostname: 'megamolbart'
    networks:
      cuchemNet:
        ipv4_address: ${IP_MEGAMOLBART}
    volumes:
        - './:/workspace'
        - "${CONTENT_PATH}/data:/data"
        - "${CONTENT_PATH}/models/megamolbart_v0.1/:/models/megamolbart/"
    user: "${UID}:${GID}"
    working_dir: ${MEGAMOLBART_PATH}
    command: python3 launch.py
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            capabilities: [gpu]
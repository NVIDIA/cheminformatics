version: "3.9"

networks:
  cuchemNet:
    name: cuchemNet
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET}

services:
  cuchemUI:
    container_name: cuchemUI
    image: ${CUCHEM_CONT}
    hostname: cuchemUI
    user: $UID:$GID
    environment:
      - CUPY_CACHE_DIR=/workspace/.cupy/kernel_cache
      - PYTHONPATH=${PYTHONPATH_CUCHEM}
    networks:
      - cuchemNet
    ports:
      - "${PLOTLY_PORT}:5000"
    volumes:
      - "./:/workspace"
      - "${CONTENT_PATH}/data:/data"
      - "${CONTENT_PATH}/logs:/logs"
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - /etc/shadow:/etc/shadow:ro
    working_dir: ${WORKING_DIR_CUCHEMUI}
    command: ${CUCHEM_UI_START_CMD}
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            capabilities: [gpu]

  megamolbart:
    image: ${MEGAMOLBART_CONT}
    user: $UID:$GID
    environment:
      - PYTHONPATH=${PYTHONPATH_MEGAMOLBART}
    networks:
      - cuchemNet
    ports:
      - "50051"
    volumes:
      - './:/workspace'
      - "${CONTENT_PATH}/data:/data"
      - "${CONTENT_PATH}/models:/models"
      - "${CONTENT_PATH}/logs:/logs"
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - /etc/shadow:/etc/shadow:ro
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: ${WORKING_DIR_MEGAMOLBART}
    command: python3 -m megamolbart
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            capabilities: [gpu]

  cddd:
    image: ${CDDD_CONT}
    user: $UID:$GID
    networks:
      - cuchemNet
    ports:
      - "50051"
    volumes:
      - './:/workspace'
      - "${CONTENT_PATH}/data:/data"
      - "${CONTENT_PATH}/models:/models"
      - "${CONTENT_PATH}/logs:/logs"
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - /etc/shadow:/etc/shadow:ro
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: ${WORKING_DIR_CDDD}
    command: '/opt/conda/envs/rapids/bin/python -m cdddinf'
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            capabilities: [gpu]

  nginx:
    image: nginx:1.20.0
    container_name: cuchemLB
    ports:
      - "50052:50052"
    depends_on:
      - megamolbart
    networks:
      - cuchemNet
    volumes:
      - ${NGINX_CONFIG}:/etc/nginx/nginx.conf:ro
